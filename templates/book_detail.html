<!DOCTYPE html>
<!-- import font -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>{{ book.Title }} – ShelfSpace</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <!-- top navbar -->
    <div class="navbar">
        <div class="nav-left">
            <a href="{{ url_for('home') }}">Home</a>
            <a class="navbar_active" href="{{ url_for('books') }}">Books</a>
            <a href="{{ url_for('about') }}">About</a>
            <a href="{{ url_for('contact') }}">Contact</a>
        </div>
        <div class="nav-center">
            <img src="{{ url_for('static', filename='images/logo.png') }}" />
        </div>
        <div class="nav-right">
            {% if not current_user.is_authenticated %}
            <a href="{{ url_for('register') }}">Register</a>
            <a href="{{ url_for('login') }}">Log In</a>
            {% else %}
            <p>Hello, {{ current_user.username }}!</p>
            {% if current_user.role == 'customer' %}
            <a href="{{ url_for('view_cart') }}" class="cart-link">
                <img src="{{ url_for('static', filename='images/cart-icon.png') }}" alt="Cart" class="cart-icon">
                {% if cart_count and cart_count > 0 %}
                <span class="cart-badge">{{ cart_count }}</span>
                {% endif %}
            </a>
            <a href="{{ url_for('view_wishlist') }}" class="wishlist-link">
                <img src="{{ url_for('static', filename='images/heart-icon.png') }}" alt="Wishlist" class="wishlist-icon">
            </a>
            {% endif %}
            <a href="{{ url_for('account_details') }}">Account</a>
            <a href="{{ url_for('logout') }}">Log Out</a>
            {% endif %}
        </div>
    </div>

    <!-- flash message pop ups -->
    <div class="flash-container">
        {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
        <div class="flash-messages">
            {% for category, message in messages %}
            <div class="flash {{ category }}">{{ message }}</div>
            {% endfor %}
        </div>
        {% endif %}
        {% endwith %}
    </div>

    <!-- main page content -->
    <div class="edit-page">

        <!-- back button -->
        <a href="{{ url_for('books') }}" class="back-top-left">← Back to Books</a>


        <!-- book details box -->
        <div class="edit-wrapper">
            <!-- book cover -->
            <div class="edit-image">
                <img src="{{ url_for('static', filename='book_covers/' ~ book.ISBN ~ '.jpg') }}"
                     onerror="this.onerror=null; this.src='{{ url_for('static', filename='book_covers/default.jpg') }}';"
                     alt="Cover for {{ book.Title }}">
            </div>

            <!-- book info -->
            <div class="edit-box">
                <h2>{{ book.Title }}</h2>

                <p><strong>Author:</strong> {{ book.Author }}</p>
                <p><strong>Genre:</strong> {{ book.Genre }}</p>
                <p><strong>Price:</strong> ${{ book.Price }}</p>
                {% if current_user.role != 'customer' %}
                <p><strong>Stock:</strong> {{ book.StockQty }}</p>
                {% endif %}

                <p><strong>Description:</strong></p>
                <p>{{ book.Description }}</p>

                <!-- book ratings -->
                {% if reviews|length > 0 %}
                <div class="stars">
                    {% for i in range(1, 6) %}
                    {% if i <= book.avg_rating|round(0, 'floor') %}
                    ★
                    {% else %}
                    ☆
                    {% endif %}
                    {% endfor %}
                    ({{ book.avg_rating }})
                </div>
                {% else %}
                <div class="stars">
                    ☆☆☆☆☆ (0.0)
                </div>
                {% endif %}

                <!-- employee actions -->
                <div class="book-actions">
                    {% if current_user.role != 'customer' %}

                    <!-- edit book -->
                    <form method="get" action="{{ url_for('edit_book', isbn=book.ISBN) }}" style="display:inline;">
                        <button type="submit">Edit</button>
                    </form>

                    <!-- delete book -->
                    <form method="post" action="{{ url_for('delete_book', isbn=book.ISBN) }}" style="display:inline;">
                        <button type="submit">Delete</button>
                    </form>
                    {% else %}

                    <!-- non-employee actions -->
                    <!-- add to cart -->
                    <form method="POST" action="{{ url_for('add_to_cart', isbn=book.ISBN) }}" style="display:inline;">
                        <button type="submit">Add to Cart</button>
                    </form>

                    <!-- add to wishlist -->
                    <form method="POST" action="{{ url_for('add_to_wishlist', isbn=book.ISBN) }}" style="display:inline;">
                        <button type="submit">Wishlist</button>
                    </form>
                    {% endif %}
                </div>

                {% if current_user.role == 'customer' %}

                <!-- add review -->
                <form action="{{ url_for('add_review', isbn=book.ISBN) }}" method="get" style="margin: 16px 0;">
                    <button type="submit" class="review-btn">Write a Review</button>
                </form>
                {% endif %}

                <!-- review sorting and filtering -->
                <div class="reviews">
                    <h2>Reviews ({{ reviews|length }})</h2>
                    <div class="review-sort-bar">
                        <form action="" method="get">

                            <!-- sort dropdown -->
                            <label>Sort:</label>
                            <select name="sort" onchange="this.form.submit()">
                                <option value="">Default</option>
                                <option value="low" {% if request.args.get('sort')= ='low' %}selected{% endif %}>Rating: Low → High</option>
                                <option value="high" {% if request.args.get('sort')= ='high' %}selected{% endif %}>Rating: High → Low</option>
                            </select>

                            <!-- filter dropdown -->
                            <label style="margin-left:12px;">Filter:</label>
                            <select name="stars" onchange="this.form.submit()">
                                <option value="">All</option>
                                {% for i in range(5,0,-1) %}
                                <option value="{{ i }}" {% if request.args.get('stars')= =i|string %}selected{% endif %}>
                                    {{ i }} ★ reviews
                                </option>
                                {% endfor %}
                            </select>
                        </form>
                    </div>

                    <!-- display filtered reviews -->
                    {% if filtered_reviews|length > 0 %}
                    {% for r in filtered_reviews %}
                    <div class="review">
                        <p><strong>{{ r.Username }}</strong> ({{ r.Date }})</p>
                        <p>Rating: {{ r.Rating }}/5</p>
                        <p>{{ r.ReviewText }}</p>
                        {% if current_user.role != 'customer' %}
                        <form class="book-actions" action="{{ url_for('delete_review_employee', review_id=r.ReviewID, isbn=book.ISBN) }}" method="post" style="margin: 16px 0;">
                            <button type="submit" class="remove">Delete Review</button>
                        </form>
                        {% endif %}
                    </div>
                    {% endfor %}
                    {% else %}
                    <p>No reviews yet.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</body>
</html>

